
#include <string>
#include "FunctionalHelpers.hpp"

#include "SortableDefinitions.hpp"
#include "GenerateNetworkVerifier.hpp"

namespace codegeneration
{

void WriteNetworkVerification(CPlusPlusCodeGenerator* gen)
{
    gen->WriteLine(GetAutogeneratedPreamble());
    gen->WriteHeaderPragma("VERIFY_NETWORKS_GENERATED_H", [=](){
        gen->WriteIncludeBrackets(
            "inttypes.h",
            "ostream");
        gen->WriteLine("");

        gen->WriteIncludeQuotes(
            "Networks_Fwd.h",
            "conditional_swap/ConditionalSwap.h",
            "VerifyNetworks.h",
            "DebugHelper.h");
        gen->WriteLine("");

        gen->WriteNamespace("verification", [=](){
            gen->WriteLine("");

            std::vector<std::string> network_nested_namespaces = {"best", "bosenelson", "bosenelson_2", "bosenelsonparallel", "bosenelsonparameter", "bosenelsonrecursive", "batcher"};
            gen->WriteLine("void VerifyNetworks()");
            gen->WriteBlock([=]{
                gen->WriteLine("int numberOfIncorrectNetworks = 0;");
                Multicall<std::string>(
                    [=](std::string name)
                    {
                        gen->WriteLine("debug::WriteLine(\"verifying ", name, " networks\");");
                        gen->WriteForLoop("arraySize", 2, 17, [=](){
                            gen->WriteLine("debug::WriteLine(\"verifying size \", arraySize);");
                            gen->WriteLine("bool result = verification::VerifyNetwork(arraySize, &networks::", name, "::sortN<conditional_swap::CS_Int, int>);");
                            gen->WriteLine("if (!result)");
                            gen->WriteBlock([=]{
                                gen->WriteLine("debug::WriteLine(\"incorrect network: '", name, "' for size '\", arraySize, \"'.\");");
                                gen->WriteLine("numberOfIncorrectNetworks += 1;");
                            });
                        });
                    },
                    network_nested_namespaces);
                int totalNetworks = network_nested_namespaces.size() * (16-2+1);
                gen->WriteLine("debug::WriteLine(\"finished verification. \", ", totalNetworks, " - numberOfIncorrectNetworks, \" networks out of ", totalNetworks, " sorted correctly.\");");
            });

            std::vector<std::string> swap_namespaces;
            for (auto str : *VectorWhere<SortableStruct*>(sortableStructs(), [](SortableStruct *str){return str->UseForNetworkSort();}))
            {
                swap_namespaces.push_back(str->CSName());
            } 
            gen->WriteLine("void VerifySwaps()");
            gen->WriteBlock([=]{
                gen->WriteLine("int numberOfIncorrectSwaps = 0;");
                gen->WriteLine("bool result = false;");
                Multicall<std::string>(
                    [=](std::string name)
                    {
                        gen->WriteLine("debug::WriteLine(\"verifying ", name, " swap\");");
                        gen->WriteLine("result = verification::VerifySwap<", name, ">();");
                        gen->WriteLine("if (!result)");
                        gen->WriteBlock([=]{
                            gen->WriteLine("debug::WriteLine(\"incorrect swap: '", name, "'.\");");
                            gen->WriteLine("numberOfIncorrectSwaps += 1;");
                        });
                    },
                    swap_namespaces);
                int totalSwaps = swap_namespaces.size();
                gen->WriteLine("debug::WriteLine(\"finished verification. \", ", totalSwaps, " - numberOfIncorrectSwaps, \" swaps out of ", totalSwaps, " swapped correctly.\");");
            });
        }, "");
    });
}

}